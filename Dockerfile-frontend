# =======================
# 1. Build React App
# =======================
FROM node:22-alpine AS build
WORKDIR /app

# Install git only if you really need it
RUN apk add --no-cache git

# --- Dependencies layer (better cache) ---
# Only copy package files first
COPY travel/package*.json ./

RUN npm config set registry https://registry.npmjs.org/ \
 && npm config set fetch-retries 5 \
 && npm config set fetch-timeout 200000 \
 && npm config set fetch-retry-maxtimeout 120000 \
 && npm install

# --- App source ---
# Now copy the rest of the frontend source
COPY travel/ ./

# Build production bundle
RUN npm run build

# =======================
# 2. Serve with NGINX
# =======================
FROM nginx:1.25-alpine

# Copy built files to nginx
COPY --from=build /app/dist /usr/share/nginx/html

# Nginx config
COPY ./nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

HEALTHCHECK CMD wget --spider -q http://localhost:80/ || exit 1

CMD ["nginx", "-g", "daemon off;"]
